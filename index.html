<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Knob Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #eef2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; color: #333;}
    .card { background: white; width: 100%; max-width: 380px; padding: 30px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.08); }
    h2 { margin: 0 0 20px 0; font-weight: 700; color: #2c3e50; text-align: center; }
    
    .status-bar { display: flex; justify-content: space-between; background: #f8f9fa; padding: 10px 15px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; margin-bottom: 25px;}
    .status-item { display: flex; align-items: center; gap: 6px; }
    .dot { height: 8px; width: 8px; border-radius: 50%; }
    .green { background-color: #00c853; } .red { background-color: #ff3d00; } .grey { background-color: #b0bec5; }

    .target-box { text-align: center; margin-bottom: 25px; }
    .target-val { font-size: 3rem; font-weight: 700; color: #3f51b5; }
    input[type=range] { width: 100%; margin: 15px 0; }
    
    .preset-container { display: flex; justify-content: space-between; margin-bottom: 30px; gap: 10px; }
    .btn-preset { flex: 1; padding: 10px; border: none; border-radius: 8px; background: #f1f3f9; cursor: pointer; font-weight: 600; }
    .btn-preset:active { background: #3f51b5; color: white; }

    .pulse-box { text-align: center; padding: 20px; border-radius: 16px; background: white; border: 2px solid #f0f0f0; }
    .big-number { font-size: 2.5rem; font-weight: 700; color: #333; margin: 5px 0 0 0; }
    
    /* UPDATE SECTION */
    .update-box { margin-top: 25px; background: #ECEFF1; padding: 15px; border-radius: 12px; }
    .update-input { width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.8rem; }
    .update-btn { width: 100%; padding: 10px; background: #607D8B; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .update-btn:hover { background: #546E7A; }

    .info-panel { margin-top: 25px; font-size: 0.75rem; color: #999; border-top: 1px solid #eee; padding-top: 15px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Smart Controller</h2>
    
    <div class="status-bar">
      <div class="status-item"><span id="webDot" class="dot grey"></span> <span id="webText">Web: ...</span></div>
      <div class="status-item"><span id="espDot" class="dot grey"></span> <span id="espText">ESP: ...</span></div>
    </div>

    <div class="target-box">
      <span style="font-size:0.8rem; color:#888; font-weight:700;">TARGET</span>
      <div id="targetSpan" class="target-val">0%</div>
      <input type="range" min="0" max="100" value="0" id="slider" onchange="sendTarget(this.value)" oninput="updateLabel(this.value)">
      <div class="preset-container">
        <button class="btn-preset" onclick="quickSet(0)">0%</button>
        <button class="btn-preset" onclick="quickSet(50)">50%</button>
        <button class="btn-preset" onclick="quickSet(100)">100%</button>
      </div>
    </div>
    
    <div id="pulseContainer" class="pulse-box">
      <span style="font-size:0.8rem; color:#888; font-weight:700;">ACTUAL</span>
      <p id="livePulse" class="big-number">--%</p>
    </div>

    <div class="update-box">
      <input type="text" id="fwUrl" class="update-input" placeholder="Paste Firmware URL here (.bin)">
      <button class="update-btn" onclick="sendUpdate()">ðŸš€ Start WAN Update</button>
    </div>

    <div class="info-panel">
      <div class="info-row"><span>IP:</span> <span id="espIP">--</span></div>
      <div class="info-row"><span>Status:</span> <span id="espUptime">--</span></div>
    </div>
  </div>

  <script>
    const mqtt_host = "93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud";
    const mqtt_port = 8884; 
    const mqtt_user = "tohits";
    const mqtt_pass = "toh123@TOH";
    const topic_pub="tohits/set", topic_sub="tohits/status", topic_online="tohits/online", topic_info="tohits/info";
    const topic_update="tohits/update"; // New Update Topic

    var client = new Paho.MQTT.Client(mqtt_host, mqtt_port, "web_" + parseInt(Math.random()*100));
    client.onConnectionLost = function(r){ setStatus("web",false); };
    client.onMessageArrived = onMessage;
    client.connect({useSSL:true, userName:mqtt_user, password:mqtt_pass, onSuccess:onConnect, onFailure:function(){setStatus("web",false);}});

    function onConnect() {
      setStatus("web", true);
      client.subscribe(topic_sub); client.subscribe(topic_online); client.subscribe(topic_info);
    }

    function setStatus(type, isOnline) {
      document.getElementById(type+"Dot").className = isOnline ? "dot green" : "dot red";
      document.getElementById(type+"Text").innerText = type.toUpperCase() + (isOnline ? ": Online" : ": Offline");
    }

    function onMessage(msg) {
      var pl = msg.payloadString;
      if(msg.destinationName == topic_sub) document.getElementById("livePulse").innerText = pl + "%";
      else if(msg.destinationName == topic_online) setStatus("esp", pl == "Online");
      else if(msg.destinationName == topic_info) {
        try { 
            var d = JSON.parse(pl); 
            // If message has "status" (like 'Updating...'), show that instead of uptime
            if(d.status) {
                document.getElementById("espUptime").innerText = d.status;
            } else {
                document.getElementById("espIP").innerText = d.ip; 
                document.getElementById("espUptime").innerText = d.up; 
            }
        } catch(e){}
      }
    }

    function updateLabel(val) { document.getElementById("targetSpan").innerText = val + "%"; }
    function quickSet(val) { document.getElementById("slider").value = val; sendTarget(val); }
    function sendTarget(val) {
      document.getElementById("targetSpan").innerText = val + "%";
      var m = new Paho.MQTT.Message(String(val)); m.destinationName = topic_pub; client.send(m);
    }

    // --- SEND UPDATE COMMAND ---
    function sendUpdate() {
        var url = document.getElementById("fwUrl").value;
        if(url.length < 10) { alert("Please enter a valid URL!"); return; }
        
        if(confirm("Are you sure? This will restart the device.")) {
            var m = new Paho.MQTT.Message(url); 
            m.destinationName = topic_update; 
            client.send(m);
            alert("Update command sent! Watch the status.");
        }
    }
  </script>
</body>
</html>
