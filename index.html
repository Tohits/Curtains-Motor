<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Knob Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f4f7f6; padding: 20px; }
    
    .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
    h2 { margin-top: 0; color: #333; }
    
    /* Boxes */
    .pulse-box { border: 3px solid #ddd; border-radius: 15px; padding: 20px; margin: 25px 0; background-color: #fafafa; transition: border-color 0.3s; }
    .target-box { background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
    
    /* Fonts */
    .big-number { font-size: 4.5rem; font-weight: bold; color: #333; margin: 0; line-height: 1; }
    .label { font-size: 0.9rem; color: #888; text-transform: uppercase; letter-spacing: 1px;}
    .target-val { color: #007BFF; font-weight: bold; font-size: 1.5rem; }

    /* Slider */
    input[type=range] { width: 100%; height: 15px; margin-top: 10px; cursor: pointer; }
    
    /* STATUS BAR Styling */
    .status-bar { display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; margin-bottom: 20px; padding: 10px; background: #eee; border-radius: 8px;}
    .status-item { display: flex; align-items: center; }
    .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .green { background-color: #4CAF50; }
    .red { background-color: #f44336; }
    .grey { background-color: #bbb; }

    /* INFO PANEL Styling */
    .info-panel { text-align: left; font-size: 0.85rem; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 20px; color: #555; border: 1px solid #eee; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    .info-label { font-weight: bold; }
  </style>
</head>
<body>

  <div class="card">
    <h2>Smart Control</h2>
    
    <div class="status-bar">
      <div class="status-item">
        <span id="webDot" class="dot grey"></span> <span id="webText">Web: Wait</span>
      </div>
      <div class="status-item">
        <span id="espDot" class="dot grey"></span> <span id="espText">ESP: Wait</span>
      </div>
    </div>

    <div class="target-box">
      <p style="margin:0; font-size:0.9rem; color:#007BFF;">TARGET</p>
      <div id="targetSpan" class="target-val">0%</div>
      <input type="range" min="0" max="100" value="0" id="slider" onchange="sendTarget(this.value)" oninput="updateLabel(this.value)">
    </div>
    
    <div id="pulseContainer" class="pulse-box">
      <p class="label">ACTUAL</p>
      <p id="livePulse" class="big-number">--%</p>
    </div>

    <div class="info-panel">
      <div class="info-row">
        <span class="info-label">ESP IP:</span> <span id="espIP">--</span>
      </div>
      <div class="info-row">
        <span class="info-label">Uptime:</span> <span id="espUptime">--</span>
      </div>
    </div>
  </div>

  <script>
    // --- RESTORE MEMORY ---
    var savedTarget = localStorage.getItem("mySavedTarget");
    if (savedTarget) {
      document.getElementById("slider").value = savedTarget;
      document.getElementById("targetSpan").innerText = savedTarget + "%";
    }

    // --- MQTT CONFIG ---
    const mqtt_host = "93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud";
    const mqtt_port = 8884; 
    const mqtt_user = "tohits";
    const mqtt_pass = "toh123@TOH";
    
    // Topics
    const topic_pub    = "tohits/set";    
    const topic_sub    = "tohits/status"; 
    const topic_online = "tohits/online";
    const topic_info   = "tohits/info";

    var clientID = "web_" + parseInt(Math.random() * 100, 10);
    var client = new Paho.MQTT.Client(mqtt_host, mqtt_port, clientID);

    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    var options = { useSSL: true, userName: mqtt_user, password: mqtt_pass, onSuccess: onConnect, onFailure: doFail };
    
    client.connect(options);

    // --- WEB CONNECTION STATUS ---
    function onConnect() {
      console.log("Web Connected!");
      document.getElementById("webDot").className = "dot green";
      document.getElementById("webText").innerText = "Web: OK";
      
      // Subscribe to all updates
      client.subscribe(topic_sub);    // Position
      client.subscribe(topic_online); // ESP Status
      client.subscribe(topic_info);   // ESP Info (IP/Uptime)
    }

    function doFail(e) {
      document.getElementById("webDot").className = "dot red";
      document.getElementById("webText").innerText = "Web: Fail";
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        document.getElementById("webDot").className = "dot red";
        document.getElementById("webText").innerText = "Web: Lost";
      }
    }

    // --- HANDLE INCOMING DATA ---
    function onMessageArrived(message) {
      var topic = message.destinationName;
      var payload = message.payloadString;

      // 1. ESP ONLINE STATUS
      if(topic == topic_online) {
        if(payload == "Online") {
          document.getElementById("espDot").className = "dot green";
          document.getElementById("espText").innerText = "ESP: OK";
        } else {
          document.getElementById("espDot").className = "dot red";
          document.getElementById("espText").innerText = "ESP: Offline";
        }
      }

      // 2. ESP INFO (IP & Uptime)
      else if(topic == topic_info) {
        // Parse JSON: {"ip":"...", "up":"..."}
        try {
          var data = JSON.parse(payload);
          document.getElementById("espIP").innerText = data.ip;
          document.getElementById("espUptime").innerText = data.up;
        } catch(e) { console.log("JSON Error"); }
      }

      // 3. SLIDER POSITION
      else if(topic == topic_sub) {
        document.getElementById("livePulse").innerText = payload + "%";
        
        var target = document.getElementById("slider").value;
        var box = document.getElementById("pulseContainer");
        
        if (Math.abs(payload - target) <= 1) {
           box.style.borderColor = "#4CAF50"; 
           box.style.backgroundColor = "#e8f5e9";
        } else {
           box.style.borderColor = "#ff9800"; 
           box.style.backgroundColor = "#fff3e0";
        }
      }
    }

    function updateLabel(val) { document.getElementById("targetSpan").innerText = val + "%"; }

    function sendTarget(val) {
      localStorage.setItem("mySavedTarget", val);
      document.getElementById("targetSpan").innerText = val + "%";
      
      message = new Paho.MQTT.Message(val);
      message.destinationName = topic_pub;
      client.send(message);
    }
  </script>
</body>
</html>
