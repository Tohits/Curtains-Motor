<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Knob Control</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f4f7f6; padding: 20px; }
    .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
    h2 { margin-top: 0; color: #333; }
    
    .pulse-box {
      border: 3px solid #ddd; border-radius: 15px; padding: 20px; margin: 25px 0; background-color: #fafafa;
    }
    .big-number { font-size: 4.5rem; font-weight: bold; color: #333; margin: 0; line-height: 1; }
    .label { font-size: 0.9rem; color: #888; text-transform: uppercase; }
    
    input[type=range] { width: 100%; height: 10px; border-radius: 5px; background: #d3d3d3; outline: none; margin-top: 15px; -webkit-appearance: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; border-radius: 50%; background: #007BFF; cursor: pointer; }

    /* IP Input Styling */
    .ip-box { background: #e8eaf6; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
    .ip-input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 60%; text-align: center; }
    .connect-btn { padding: 8px 15px; background: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; }

    /* Status Colors */
    .idle { background-color: #b0bec5; color: #fff; padding: 10px; border-radius: 5px; display: block;}
    .cw   { background-color: #2196F3; color: white; padding: 10px; border-radius: 5px; display: block;} 
    .ccw  { background-color: #FF9800; color: white; padding: 10px; border-radius: 5px; display: block;} 
    .done { background-color: #4CAF50; color: white; padding: 10px; border-radius: 5px; display: block;} 
  </style>
</head>
<body>

  <div class="card">
    <h2>Smart Control</h2>

    <div class="ip-box">
      <p style="margin:5px 0; font-size:0.8rem;">NodeMCU IP Address:</p>
      <input type="text" id="ipInput" class="ip-input" placeholder="192.168.1.X" value="192.168.1.">
      <button class="connect-btn" onclick="saveIP()">Set</button>
    </div>
    
    <div>
      <p>Target: <b id="targetSpan" style="color:#007BFF; font-size: 1.5rem;">0</b></p>
      <input type="range" min="0" max="100" value="0" id="slider" oninput="updateTarget(this.value)" ontouchend="updateTarget(this.value)">
    </div>
    
    <div id="pulseContainer" class="pulse-box">
      <p class="label">Actual Position</p>
      <p id="livePulse" class="big-number">--</p>
    </div>

    <span id="statusText" class="idle">Not Connected</span>
  </div>

  <script>
    let nodeIP = localStorage.getItem("node_ip") || ""; 
    document.getElementById('ipInput').value = nodeIP;

    function saveIP() {
      const ip = document.getElementById('ipInput').value;
      // Add http:// if missing
      nodeIP = ip.startsWith("http") ? ip : "http://" + ip;
      localStorage.setItem("node_ip", ip); // Remember it for next time
      alert("IP set to: " + nodeIP);
    }

    function updateTarget(val) {
      if(!nodeIP) return;
      document.getElementById('targetSpan').innerText = val;
      fetch(nodeIP + "/set?value=" + val).catch(e => console.log(e));
    }

    // Poll Status
    setInterval(function() {
      if(!nodeIP) return;

      fetch(nodeIP + "/status")
        .then(response => response.json())
        .then(data => {
          document.getElementById('livePulse').innerText = data.enc;
          document.getElementById('targetSpan').innerText = data.target;
          document.getElementById('slider').value = data.target;

          var status = document.getElementById('statusText');
          
          if(data.task == 1) {
             status.innerText = "MOVING FORWARD";
             status.className = "cw";
          } else if (data.task == 2) {
             status.innerText = "MOVING REVERSE";
             status.className = "ccw";
          } else {
             if(data.enc == data.target && data.enc != 0) {
                status.innerText = "Target Reached";
                status.className = "done";
             } else {
                status.innerText = "System Ready";
                status.className = "idle";
             }
          }
        })
        .catch(error => {
          document.getElementById('statusText').innerText = "Connecting...";
          document.getElementById('statusText').className = "idle";
        });
    }, 500);
  </script>
</body>
</html>
