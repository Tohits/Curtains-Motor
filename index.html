<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Knob Control</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #f4f7f6; padding: 20px; }
    
    .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
    h2 { margin-top: 0; color: #333; }
    
    /* Live Pulse Box */
    .pulse-box {
      border: 3px solid #ddd; border-radius: 15px; padding: 20px; margin: 25px 0; background-color: #fafafa;
    }
    .big-number { font-size: 4.5rem; font-weight: bold; color: #333; margin: 0; line-height: 1; }
    
    /* Slider */
    input[type=range] { width: 100%; height: 15px; margin-top: 20px; cursor: pointer; }
    
    /* Connection Status Light */
    .status-dot { height: 15px; width: 15px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px;}
    .connected { background-color: #4CAF50; }
    .disconnected { background-color: #f44336; }
    
    .status-text { font-size: 0.8rem; color: #777; margin-bottom: 20px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>Smart Control</h2>
    
    <div class="status-text">
      <span id="connDot" class="status-dot"></span> <span id="connText">Connecting...</span>
    </div>

    <div>
      <p>Set Target: <b id="targetSpan" style="color:#007BFF; font-size: 1.5rem;">0%</b></p>
      
      <input type="range" min="0" max="100" value="0" id="slider" onchange="sendTarget(this.value)" oninput="updateLabel(this.value)">
    </div>
    
    <div id="pulseContainer" class="pulse-box">
      <p style="text-transform: uppercase; color: #888; font-size: 0.9rem;">Actual Position</p>
      <p id="livePulse" class="big-number">--%</p>
    </div>
  </div>

  <script>
    // --- MQTT CONFIGURATION ---
    const mqtt_host = "93bad3def29641e399de9a7b9c676613.s1.eu.hivemq.cloud";
    const mqtt_port = 8884; // WebSocket Secure Port
    const mqtt_user = "tohits";
    const mqtt_pass = "toh123@TOH";
    
    const topic_pub = "tohits/set";    // We send target percentage here
    const topic_sub = "tohits/status"; // We receive current percentage here

    // Create Client
    var clientID = "web_" + parseInt(Math.random() * 100, 10);
    var client = new Paho.MQTT.Client(mqtt_host, mqtt_port, clientID);

    // Set Callbacks
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    // Connect Options
    var options = {
      useSSL: true,
      userName: mqtt_user,
      password: mqtt_pass,
      onSuccess: onConnect,
      onFailure: doFail
    };

    // Attempt Connection
    console.log("Connecting to HiveMQ...");
    client.connect(options);

    function onConnect() {
      console.log("Connected!");
      document.getElementById("connDot").className = "status-dot connected";
      document.getElementById("connText").innerText = "Online";
      
      // Subscribe to updates from NodeMCU
      client.subscribe(topic_sub);
    }

    function doFail(e) {
      console.log("Connection Failed: " + e.errorMessage);
      document.getElementById("connDot").className = "status-dot disconnected";
      document.getElementById("connText").innerText = "Offline (Check Console)";
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("Connection Lost: " + responseObject.errorMessage);
        document.getElementById("connDot").className = "status-dot disconnected";
        document.getElementById("connText").innerText = "Lost Connection";
      }
    }

    // Handle Incoming Messages (From NodeMCU)
    function onMessageArrived(message) {
      if(message.destinationName == topic_sub) {
        var val = message.payloadString;
        document.getElementById("livePulse").innerText = val + "%";
        
        // Optional: Update slider position if external change happens
        // document.getElementById("slider").value = val;
      }
    }

    // Update the blue label while dragging
    function updateLabel(val) {
      document.getElementById("targetSpan").innerText = val + "%";
    }

    // Send the final value when slider is released
    function sendTarget(val) {
      document.getElementById("targetSpan").innerText = val + "%";
      
      message = new Paho.MQTT.Message(val);
      message.destinationName = topic_pub;
      client.send(message);
      console.log("Sent Target: " + val + "%");
    }
  </script>
</body>
</html>
